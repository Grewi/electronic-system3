<?php
use system\inst\classes\installItem;
use system\inst\classes\functions;

define('ENTRANSE', 'install');
define('INDEX', true);
define('ROOT', str_replace('\\', '/', dirname(__DIR__)));
define('SYSTEM', ROOT . '/system');
define('INST', SYSTEM . '/inst');
define('ITEMS', INST . '/items');
define('INSTALL_INI', ROOT . '/install.ini');
define('INSTALL_JSON', ROOT . '/install.json');
require_once SYSTEM . '/system.php';

$p = functions::parametrs();
if(isset($p['itemName']) && $p['itemName'] == 'all'){
        $installIni = functions::parseInstallIni();
        $data = [];
        if (file_exists(INSTALL_JSON)) {
            $data = json_decode(file_get_contents(INSTALL_JSON), true);
        }
        foreach($installIni as $a => $i){
            foreach($i as $aa => $ii){
                if(isset($data[$a]['relations'])){
                    if(in_array($aa, $data[$a]['relations'])){
                        continue;
                    }
                }
                $p = [];
                $p['app'] = $a;                
                $p['itemName'] = $aa;
                $p = array_merge($p, $ii);
                new installItem($p);
            }
        }
        
        exit;
}elseif (isset($p['itemName'])) {

    $iDir = ITEMS . '/' . $p['itemName'];
    if (file_exists($iDir)) {

        new installItem($p);

    } else {
        echo ('Проверьте параметры запроса. ' . $p['itemName'] . ' не найден!' . PHP_EOL);
        echo ('Для установки доступны: ' . PHP_EOL);
        functions::infoListItem();
        echo ('Для более подробной информации используйте параметр help ' . PHP_EOL);
    }

} else {
    echo 'Необходимо указать компонент установки.' . PHP_EOL;
    echo ('Для установки доступны: ' . PHP_EOL);
    functions::infoListItem();
}
