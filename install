<?php

define('ENTRANSE', 'install');
define('INDEX', true);
define('ROOT', str_replace('\\', '/', dirname(__DIR__)));
define('SYSTEM', ROOT . '/system');
define('INST', SYSTEM . '/inst');
define('ITEMS', SYSTEM . '/inst/items');
require_once SYSTEM . '/autoloader.php';

function yes(string $request) : bool
{
    $ok = ['1', 'y', 'yes', 'да', 'д'];
    return in_array(mb_strtolower($request), $ok) ? true : false;
}

function parametrs() : array
{
    global $argv;
    $r = [];
    if($argv){
        foreach($argv as $a => $i){
            if($a == 1){
                $r['itemName'] = $i;
            }elseif($a > 1){
                $s = explode('=', $i);
                $r[$s[0]] = (count($s) == 1) ? 1 : $s[1];                
            }
        }
    }
    return $r;
}

function listItems() : array
{
    $items = [];
    $itemsDir = scandir(ITEMS);
    if($itemsDir){
        foreach($itemsDir as $i){
            if($i == '.' || $i == '..'){
                continue;
            }
            $items[] = $i;
        }
    }
    return $items;
}

function complectParams($item) : bool
{
    $a = ITEMS . '/' . $item . '/params.ini';
    $b = parametrs();
    $r = true;
    if(file_exists($a)){
        $c = parse_ini_file($a);
        foreach($c as $j => $i){
            $r = $r && isset($b[$j]) ? true : false;
        }
    }
    return $r;
}

function infoListItem() : void
{
    foreach(listItems() as $i){
        $item = ITEMS . '/' . $i;
        if(file_exists($item . '/info.txt')){
            echo '    ' . $i . ': ' . file_get_contents($item . '/info.txt') . PHP_EOL;
        }else{
            echo $i . PHP_EOL;
        }
    }
}

function createDir($path) : void
{
    if (!file_exists($path)) {
        mkdir($path, 0755, true);
    }
}

function addNameRelation($param){

    if(file_exists(ROOT . '/relation.json')){
        $data = json_decode(file_get_contents(ROOT . '/relation.json'), true);
    }else{
        $data = [];
    }
    $data[$param['app']]['relations'][] = $param['itemName'];
    if(!isset($data['app'][$param['app']]['public'])){
        $data[$param['app']]['public'] = $param['public'];
    }
    $data[$param['app']]['relations'] = array_unique($data[$param['app']]['relations']);
    file_put_contents(ROOT . '/relation.json', json_encode($data));
}

function checkRelation($param){
    $data = [];
    if(file_exists(ROOT . '/relation.json')){
        $data = json_decode(file_get_contents(ROOT . '/relation.json'), true);
    }

    $relPath = ROOT . '/system/inst/items/' . $param['itemName'] . '/relations.ini';
    if(file_exists($relPath)){
        $rel = parse_ini_file($relPath);
        $r = isset($rel['items']) ? explode(',', $rel['items']) : [];

        $rr = isset($data[$param['app']]['relations']) ? $data[$param['app']]['relations'] : [];
        $res = true;
        foreach($r as $i){
            $res = in_array( trim($i), $rr) && $res ? true : false;
        }
        return $res;
    }
}

require INST . '/index.php';
